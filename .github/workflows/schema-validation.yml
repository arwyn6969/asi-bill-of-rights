name: Schema Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'schemas/**'
      - 'charter/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'schemas/**'
      - 'charter/**'

jobs:
  validate-schemas:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install jsonschema
        run: pip install jsonschema

      - name: Validate v4.0 schema
        run: |
          python3 -c "
          import json
          import sys
          from jsonschema import validate, Draft7Validator
          
          # Load schema
          with open('schemas/charter.v4.json', 'r') as f:
              schema = json.load(f)
          
          # Validate schema structure
          try:
              Draft7Validator.check_schema(schema)
              print('✓ Schema is valid JSON Schema Draft 7')
          except Exception as e:
              print(f'✗ Schema validation failed: {e}')
              sys.exit(1)
          
          # Check required fields
          required_fields = ['metadata', 'article0', 'rights', 'duties']
          for field in required_fields:
              if field not in schema.get('properties', {}):
                  print(f'✗ Missing required field: {field}')
                  sys.exit(1)
          
          print('✓ All required fields present')
          print('✓ Schema validation passed')
          "

      - name: Validate v3.0 schema
        run: |
          python3 -c "
          import json
          import sys
          from jsonschema import validate, Draft7Validator
          
          # Load schema
          with open('schemas/charter.v3.json', 'r') as f:
              schema = json.load(f)
          
          # Validate schema structure
          try:
              Draft7Validator.check_schema(schema)
              print('✓ Schema is valid JSON Schema Draft 7')
          except Exception as e:
              print(f'✗ Schema validation failed: {e}')
              sys.exit(1)
          
          print('✓ Schema validation passed')
          "

      - name: Validate contributions.json structure
        run: |
          python3 -c "
          import json
          import sys
          
          try:
              with open('contributions/contributions.json', 'r') as f:
                  data = json.load(f)
              
              # Check structure
              if 'contributions' not in data or 'statistics' not in data:
                  print('✗ Missing required structure in contributions.json')
                  sys.exit(1)
              
              # Validate statistics match actual contributions
              contributions = data['contributions']
              stats = data['statistics']
              
              if len(contributions) != stats.get('total_contributions', 0):
                  print(f'✗ Statistics mismatch: {len(contributions)} contributions but stats says {stats.get(\"total_contributions\", 0)}')
                  sys.exit(1)
              
              print('✓ contributions.json structure valid')
              print('✓ Statistics match contribution count')
          except json.JSONDecodeError as e:
              print(f'✗ Invalid JSON: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'✗ Error: {e}')
              sys.exit(1)
          "

